// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Users ============
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // OAuth 사용자는 null 가능
  username  String
  nickname  String?
  membership Membership @default(FREE)
  roles     String[] @default(["USER"])
  
  // 크레딧 시스템
  credits   Int      @default(0)  // 보유 크레딧
  
  // OAuth 정보
  provider  String?  // google, kakao, local
  providerId String? // OAuth provider의 user ID
  
  // Relations
  subscriptions Subscription[]
  recommendations Recommendation[]
  paymentMethods PaymentMethod[]
  favorites Favorite[]
  stickers UserSticker[]
  creditPurchases CreditPurchase[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([provider, providerId])
  @@map("users")
}

enum Membership {
  FREE
  PREMIUM
}

// ============ Subscriptions ============
model Subscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  membership Membership
  interval  BillingInterval
  price     Int
  billingKey String
  
  nextBillingDate DateTime
  status    SubscriptionStatus @default(ACTIVE)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("subscriptions")
}

enum BillingInterval {
  WEEKLY
  MONTHLY
  ANNUALLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  FAILED
}

// ============ Payment Methods ============
model PaymentMethod {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  billingKey String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("payment_methods")
}

// ============ Recommendations ============
model Recommendation {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  imageUrl  String?
  occasion  String
  tastes    String[]
  drinks    Json     // Array of drink objects
  fairyMessage String?
  
  createdAt DateTime @default(now())
  
  @@map("recommendations")
}

// ============ Payments ============
model Payment {
  id        String   @id @default(cuid())
  userId    String
  
  paymentKey String @unique
  orderId   String @unique
  amount    Int
  status    PaymentStatus
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// ============ Drinks ============
model Drink {
  id        String   @id @default(cuid())
  name      String
  type      String   // sparkling, red wine, white wine, tea, non-alcoholic, etc.
  description String
  tastingNotes String[] // fruity, elegant, light, etc.
  image     String?
  price     String
  purchaseUrl String? // 쿠팡 구매 링크
  
  // Pairing info
  foodPairings String[] // seafood, meat, pasta, cheese, etc.
  occasions String[]   // date, solo-drinking, camping, gathering, solo-meal
  tastes    String[]   // sweet, bitter, sour, light, medium, heavy
  
  // Relations
  favorites Favorite[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("drinks")
}

// ============ Favorites ============
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  drinkId   String
  drink     Drink    @relation(fields: [drinkId], references: [id], onDelete: Cascade)
  drinkName String
  drinkType String
  drinkImage String?
  
  createdAt DateTime @default(now())
  
  @@unique([userId, drinkId])
  @@map("favorites")
}

// ============ Support Messages ============
model SupportMessage {
  id        String   @id @default(cuid())
  userId    String?
  email     String?
  message   String
  
  createdAt DateTime @default(now())
  
  @@map("support_messages")
}

// ============ Credit Purchases (크레딧 구매 내역) ============
model CreditPurchase {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  packageType String  // CREDIT_5, CREDIT_10, CREDIT_30
  credits   Int      // 구매한 크레딧 수
  price     Int      // 결제 금액
  
  paymentKey String? // Toss 결제 키
  orderId   String   @unique
  status    PaymentStatus @default(PENDING)
  
  createdAt DateTime @default(now())
  
  @@map("credit_purchases")
}

// ============ Stickers (수집형 배지) ============
model UserSticker {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stickerId String   // first-recommendation, wine-lover, night-owl, etc.
  unlockedAt DateTime @default(now())
  
  @@unique([userId, stickerId])
  @@map("user_stickers")
}

// ============ Standard Menu (정규화 테이블) ============
model StandardMenu {
  id        String   @id @default(cuid())
  
  // 표시 이름
  displayName String
  displayNameEn String?
  
  // 카테고리
  category  String   // meat, seafood, pasta, dessert, etc.
  subcategory String? // beef, pork, cream, tomato, etc.
  cuisine   String?  // korean, italian, japanese, etc.
  
  // 특성
  fatLevel  String?  // low, medium, high
  sweetness String?  // low, medium, high
  spiciness String?  // low, medium, high
  
  // 매칭 키워드 (OCR 결과 매핑용)
  keywords  String[] // ["스테이크", "steak", "ribeye", "등심"]
  
  // 추천 가중치
  weight    Float @default(1.0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("standard_menus")
}

// ============ Pairing Rules (추천 룰) ============
model PairingRule {
  id        String   @id @default(cuid())
  
  // 음식 조건
  menuCategory String
  menuSubcategory String?
  
  // 상황 조건 (optional)
  occasion  String?
  
  // 추천 음료
  drinkTypes String[] // ["wine-red", "whiskey"]
  drinkTastes String[] // ["bold", "rich"]
  
  // 점수 가중치
  score     Float @default(1.0)
  
  // 추천 이유
  reason    String
  reasonEn  String?
  
  // 활성화 여부
  isActive  Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("pairing_rules")
}

// ============ AI Recommendation Cache (AI 추천 캐시) ============
model AiRecommendationCache {
  id        String   @id @default(cuid())
  
  // Vision 분석 결과 (캐시 키로 사용)
  foodKeywords String[] // ["steak", "grilled", "beef"]
  foodCategory String   // meat, seafood, pasta, etc.
  occasion  String?    // date, solo-drinking, etc.
  tastes    String[]   // sweet, bitter, etc.
  
  // 캐시 키 (해시값)
  cacheKey  String @unique
  
  // Gemini 추천 결과
  recommendations Json // Array of { drinkId, drinkName, drinkType, reason, score }
  fairyMessage String // 페어리의 추천 설명
  
  // 사용 통계
  hitCount  Int @default(0)
  lastUsedAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([cacheKey])
  @@index([foodCategory, occasion])
  @@map("ai_recommendation_cache")
}
